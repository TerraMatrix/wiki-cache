## 一、需求背景与目的

在地形数据生产与融合过程中，常需将多景 DEM 数据按照预先生成的镶嵌线网络进行拼接（镶嵌）。为保证镶嵌边界平滑、避免突变，需在镶嵌线邻域执行羽化平滑处理，实现高程值的自然过渡。

现有方法在大数据场景（数百GB级 DEM）中存在内存瓶颈，无法一次性加载全图进行卷积或平滑计算。 因此，本需求旨在研发一套基于欧氏距离变换（EDT）的高效 DEM 镶嵌与羽化算法模块， 重点解决：

- 大数据量 DEM 镶嵌的内存分块与并行处理问题；
- 接缝区域的高效羽化平滑；
- 以及单景 DEM 的局部羽化能力。

﻿

﻿

## 二、功能需求

### 2.1 主功能：多景 DEM 镶嵌与羽化

#### 输入数据

- 多景 DEM 栅格数据序列（可能为超大数据量，合计>数百GB）；
- 镶嵌线网络矢量数据（线型要素，拓扑一致、闭合）。

#### 输出数据

- 羽化平滑后的镶嵌 DEM 栅格；
- 可选输出：羽化权重掩膜、镶嵌线邻域 DEM 差值统计。

#### 核心处理流程

1. 镶嵌分区与区域归属： 根据镶嵌线网络确定每张 DEM 的归属区域。
2. 欧氏距离变换（EDT）距离场计算： 对每个 DEM 掩膜生成距离场，用于权重计算。
3. 权重计算与羽化融合： 按设定的羽化半径生成权重场； 在镶嵌带内按权重融合、带外直接取原值。
4. 分块与边界一致性处理：
   - 采用 tile-based 分块策略；
   - 各 tile 计算含有 halo 区（外扩区）以保持平滑连续；
   - 分块间结果在核心区无缝拼接。
5. 输出拼接结果： 支持直接输出 GeoTIFF 格式。其他格式让用户使用格式转换工具自行转换。

﻿

﻿

### 2.2 羽化参数说明

- 羽化半径（Feather Radius）
  - 控制羽化影响范围（单位：像元）；
  - 算法基于欧氏距离变换，计算复杂度与半径无关。
- 羽化模式（Feather Mode）
  - 控制羽化带内的权重分布形态（相当于“羽化柔和度”）：
  - 模式体现为不同羽化曲线形态，不单独设置平滑强度参数。

﻿

|          |                                                              |                    |                         |
| -------- | ------------------------------------------------------------ | ------------------ | ----------------------- |
| 模式     | 权重函数                                                     | 特征               | 应用建议                |
| Linear   | f(d)=1−d/Wf(d)=1-d/Wf(d)=1−d/W                               | 过渡较硬，边界清晰 | 科学计算或 DEM 差值分析 |
| Cosine   | f(d)=0.5(1+cos⁡(πd/W))f(d)=0.5(1+\cos(\pi d/W))f(d)=0.5(1+cos(πd/W)) | 过渡自然、视觉平滑 | 默认推荐模式            |
| Gaussian | f(d)=e−(d/σ)2,σ≈W/2f(d)=e^{-(d/\sigma)^2}, \sigma≈W/2f(d)=e−(d/σ)2,σ≈W/2 | 最柔和，视觉最优   | 对接缝敏感区域          |

﻿

﻿

﻿

### 2.3 附加功能：单景 DEM 局部羽化

- 支持对单景 DEM 导入矢量边界，对该边界生成以羽化半径为宽度的缓冲区，在缓冲带内执行同样的距离加权羽化平滑；
- 用于 DEM 裁剪、修复、掩膜融合的边界平滑。

﻿

﻿

## 三、技术与性能要求

### 3.1 核心算法

- 欧氏距离变换（EDT） + 距离权重映射；
- 加权归一化融合；
- tile-based 分块 + halo 缓冲区拼接策略。

### 3.2 大数据处理要求

- 分块计算：
  - 必须支持按指定 tile 大小（如 4096×4096 或自适应）分块处理；
  - 每个分块应在主存内独立完成计算；
  - 分块外侧 halo 区宽度≥羽化半径，确保拼接连续性；
  - 核心输出区与 halo 区无缝衔接。
- 内存控制：
  - 模块应支持内存阈值参数，确保同时处理的块数可控；
  - 内存峰值占用 ≤ 单块加载数据大小的 1.5 倍。
- 并行处理：
  - 支持多线程或多进程并行；
  - 任务调度可自动按分块划分；
  - 并行计算时保持边界一致性。

### 3.3 性能指标

- 复杂度 O(N)，与羽化半径无关；
- 对于 10 幅 1GB DEM（典型 10000×10000 像元）：
  - 总处理时间 ≤ 原高斯卷积法 50%；
  - 内存占用 ≤ 单景数据的 1.5 倍；
  - 输出接缝连续、无伪影。

### 3.4 精度要求

- DEM 高程连续性误差 ≤ 原始分辨率的 1/10；
- 接缝区域 RMSE < 0.5 像元。

﻿

﻿

## 四、参数与配置项

﻿

|                   |      |            |                                          |
| ----------------- | ---- | ---------- | ---------------------------------------- |
| 参数名称          | 类型 | 默认值     | 说明                                     |
| feather_radius    | 整型 | 20         | 羽化半径（像元）                         |
| feather_mode      | 枚举 | cosine     | 羽化模式： linear /  cosine /  gaussian  |
| tile_size         | 整型 | 4096       | 分块尺寸                                 |
| overlap_halo      | 整型 | 自动(Wmax) | 分块外扩区宽度（自动设为羽化半径）       |
| max_memory_MB     | 整型 | 4096       | 最大内存占用阈值（用于动态控制并行块数） |
| num_threads       | 整型 | 自动       | 并行线程数（可根据CPU核心数自动设置）    |
| output_weight_map | 布尔 | False      | 是否输出权重掩膜结果                     |

﻿

﻿

﻿

## 五、测试与验收标准

﻿

|            |                                                              |
| ---------- | ------------------------------------------------------------ |
| 测试项     | 验收标准                                                     |
| 功能正确性 | 输入多景 DEM 与镶嵌线矢量后，输出无缝镶嵌结果；权重掩膜分布连续；单景羽化模式正确执行。 |
| 性能指标   | 处理性能达到 O(N)；在大规模 DEM（>100GB）场景下可稳定运行。  |
| 内存控制   | 内存峰值不超过设定阈值；分块拼接无断层。                     |
| 视觉平滑性 | DEM 接缝过渡自然，无突变、无锯齿。                           |
| 精度一致性 | RMSE < 0.5 像元；高程分布无异常台阶。                        |

﻿

﻿

﻿

## 六、备注

- 本模块面向大规模 DEM 数据，必须支持分块、并行与内存管理机制；
- “羽化模式”体现不同的羽化曲线形态，不再提供额外“平滑程度”参数；
- 模块应具备可扩展性，为后续 GPU 加速或分布式计算预留接口；
- 推荐实现栈：GDAL + OpenCV + 并行调度框架（如 Dask / OpenMP / TBB）。